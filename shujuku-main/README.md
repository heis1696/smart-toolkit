# shujuku（神·数据库）

## 触发规则（已修复"其它插件 API 调用误触发"）

为避免其它扩展/插件的后台调用（尤其是 quiet/后台生成、工具调用）误触发本脚本的逻辑，本项目对触发条件做了门控：

- **剧情推进**：仅在 **用户在酒馆界面真实发送消息** 时触发（`MESSAGE_SENT` → 紧随其后的 `GENERATION_AFTER_COMMANDS`），并且会过滤 `quiet_prompt` / `type === 'quiet'` / `automatic_trigger`。
- **自动填表更新**：仅在 **本次生成不是 quiet/后台生成** 时触发（通过 `GENERATION_STARTED` 记录上下文，在 `GENERATION_ENDED` 时过滤）。

如需调整"用户发送→生成"的容忍窗口，可在 `shujuku/index.js` 中搜索并修改 `USER_SEND_TRIGGER_TTL_MS_ACU`。

---

## 更新日志

### 2026-02-26填表自动重试次数设置功能

#### 新增功能
- **填表自动重试次数设置**：为填表功能新增可配置的自动重试次数，支持在错误或空回（低于回复字符）时自动重试。

#### 修改内容

| 文件 | 代码行数区间 | 修改说明 |
|------|-------------|----------|
| `index.js` | 2883-2884 | 新增UI变量声明 `$tableMaxRetriesInput_ACU` |
| `index.js` | 2945-2946 | 在默认设置中添加 `tableMaxRetries: 3` 配置项 |
| `index.js` | 8783-8801 | 新增 `saveTableMaxRetries_ACU()` 保存函数 |
| `index.js` | 14726-14732 | 在UI界面新增"填表自动重试次数"输入框 |
| `index.js` | 15514 | UI初始化时绑定 `$tableMaxRetriesInput_ACU` 元素 |
| `index.js` | 16222 | 添加自动保存事件绑定 |
| `index.js` | 8268 | 在 `loadSettings_ACU()` 中加载重试次数设置 |
| `index.js` | 19676 | 修改 `proceedWithCardUpdate_ACU()` 使用可配置的重试次数 |

#### 使用说明
1. 在插件设置界面的"公用设置"区域找到"填表自动重试次数"输入框
2. 输入1-10之间的整数（默认为3次）
3. 设置会自动保存
4. 当填表过程中出现错误或AI回复为空/过短时，系统会自动重试，最多重试设定的次数

### 2026-02-26 剧情推进API错误重试修复

#### 修复问题
- **剧情推进API错误重试**：修复了剧情推进功能在API调用失败（如网络错误、API超时等）时直接中断的问题，现在会自动重试。

#### 修改内容

| 文件 | 代码行数区间 | 修改说明 |
|------|-------------|----------|
| `index.js` | 7517-7580 | 重构剧情推进API调用逻辑，添加统一的错误重试机制 |

#### 改进内容
1. **统一重试逻辑**：无论 `minLength` 是否大于0，都支持API错误重试
2. **可配置重试次数**：使用 `plotSettings.loopSettings.maxRetries` 配置（默认3次）
3. **错误捕获**：API调用添加 try-catch，捕获网络错误、API超时等异常
4. **递增等待时间**：重试间隔采用递增策略（1秒、2秒、3秒...）
5. **友好提示**：显示具体的错误信息，帮助用户了解失败原因

#### 注意事项
- 剧情推进的重试次数使用的是"循环设置"中的"最大重试"参数
- 用户中止操作不会触发重试，会直接返回

### 2026-02-26 填表重试逻辑完善

#### 修复问题
- **填表统一重试逻辑**：完善填表功能的重试机制，现在任意错误（API错误、空回、解析失败）都会进入重试。

#### 修改内容

| 文件 | 代码行数区间 | 修改说明 |
|------|-------------|----------|
| `index.js` | 19770-19850 | 重构填表重试逻辑，统一处理所有错误类型 |

#### 改进内容
1. **统一错误处理**：API调用失败、空回（低于回复字符阈值）、解析失败都进入重试
2. **空回检测**：在重试循环内检测AI回复长度，低于 `autoUpdateTokenThreshold` 阈值时触发重试
3. **解析失败重试**：解析或应用AI更新失败时不再直接抛出，而是进入重试
4. **递增等待时间**：重试间隔采用递增策略（1秒、2秒、3秒...）
5. **用户可取消**：用户随时可以通过点击取消按钮结束任务与所有重试
6. **友好提示**：显示具体的错误信息，帮助用户了解失败原因

#### 重试逻辑流程
1. 检查用户是否已取消 → 是则退出
2. 调用API → 失败则重试
3. 检查空回 → 低于阈值则重试
4. 检查tableEdit标签 → 缺失则重试
5. 解析并应用更新 → 失败则重试
6. 成功则退出循环
7. 达到最大重试次数 → 反馈失败并结束任务