# Smart Toolkit é¡¹ç›®æ¶æ„æ–‡æ¡£

> SillyTavern æ‰©å±•æ’ä»¶ï¼Œæä¾›æ¨¡å—åŒ–çš„å·¥å…·é›†ã€‚  
> ä»“åº“ï¼šhttps://github.com/heis1696/smart-toolkit

---

## ç›®å½•ç»“æ„

```
smart-toolkit/
â”œâ”€â”€ package.json          # é¡¹ç›®é…ç½® & æ„å»ºè„šæœ¬
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js          # å…¥å£ï¼šæ³¨å†Œæ¨¡å—ã€ç»‘å®šäº‹ä»¶ã€åˆå§‹åŒ–ä¸–ç•Œä¹¦
â”‚   â”œâ”€â”€ core.js           # æ ¸å¿ƒå±‚ï¼šè®¾ç½®ç®¡ç†ã€æ¶ˆæ¯å·¥å…·ã€API è¯·æ±‚ã€ä¸–ç•Œä¹¦ç®¡ç†
â”‚   â”œâ”€â”€ ui.js             # UI å±‚ï¼šé¡¶æ æŒ‰é’®ã€ä¾§æ»‘é¢æ¿ã€å…±äº«é…ç½® + æ¨¡å—ç®¡ç†
â”‚   â””â”€â”€ modules/
â”‚       â””â”€â”€ statusbar.js  # æ¨¡å—ï¼šçŠ¶æ€æ ç”Ÿæˆå™¨
â””â”€â”€ dist/
    â””â”€â”€ bundle.js         # esbuild æ„å»ºäº§ç‰© (IIFE)
```

## æ„å»º

```bash
npm run build   # å•æ¬¡æ„å»º
npm run watch   # ç›‘å¬æ¨¡å¼
```

---

## æ ¸å¿ƒæ¶æ„

### ä¸‰å±‚è®¾è®¡

```
index.js (å…¥å£/äº‹ä»¶æ€»çº¿)
    â”œâ”€â”€ core.js (æ•°æ® & é€»è¾‘ & ä¸–ç•Œä¹¦)
    â””â”€â”€ ui.js   (é¡¶æ é¢æ¿ & äº¤äº’)
            â””â”€â”€ modules/* (åŠŸèƒ½æ¨¡å—)
```

### 1. `index.js` â€” å…¥å£

èŒè´£ï¼šåˆå§‹åŒ–æ¨¡å—ã€æ¸²æŸ“ UIã€åˆå§‹åŒ–ä¸–ç•Œä¹¦ã€ç›‘å¬ SillyTavern äº‹ä»¶ã€‚

| äº‹ä»¶ | å¤„ç† |
|------|------|
| `MESSAGE_RECEIVED` | èŠ‚æµ 3sï¼Œä¾æ¬¡è°ƒç”¨å„æ¨¡å— `onMessage(msgId)` |
| `CHAT_COMPLETION_SETTINGS_READY` | è°ƒç”¨å„æ¨¡å— `onChatReady(data)` |

### 2. `core.js` â€” æ ¸å¿ƒå·¥å…·

| åŠŸèƒ½ç»„ | æ–¹æ³• | è¯´æ˜ |
|--------|------|------|
| **è®¾ç½®ç®¡ç†** | `getSettings()` | è·å–æ’ä»¶å…¨å±€è®¾ç½®å¯¹è±¡ |
| | `saveSettings()` | é˜²æŠ–ä¿å­˜ |
| | `getModuleSettings(id, defaults)` | è·å–æ¨¡å—è®¾ç½®ï¼Œè‡ªåŠ¨å¡«å……é»˜è®¤å€¼ |
| **ä¸–ç•Œä¹¦** | `ensureWorldBook(modules)` | åˆ›å»º/æ£€æŸ¥ä¸–ç•Œä¹¦ã€Œå·¥å…·ä¹¦ã€ï¼ŒåŒæ­¥æ¨¡æ¿æç¤ºè¯ |
| | `getWorldBookEntry(key)` | è¯»å–ä¸–ç•Œä¹¦æ¡ç›®å†…å®¹ |
| | `setWorldBookEntry(key, content)` | æ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®å†…å®¹ |
| **æ¶ˆæ¯å·¥å…·** | `getChat()` | å½“å‰èŠå¤©æ•°ç»„ |
| | `getLastMessageId()` | æœ€åä¸€æ¡æ¶ˆæ¯ç´¢å¼• |
| **å†…å®¹æå–** | `extractContent(text, opts)` | æŒ‰æ ‡ç­¾æå– + æ­£åˆ™æ¸…ç† |
| **API è¯·æ±‚** | `requestExtraModel(opts)` | æ”¯æŒä¸‰ç§è¯·æ±‚æ¨¡å¼çš„é¢å¤–æ¨¡å‹è°ƒç”¨ |

### 3. `ui.js` â€” UI æ¸²æŸ“

èŒè´£ï¼š
- åœ¨é¡¶æ  `#top-settings-holder` æ·»åŠ å·¥å…·ç®±æŒ‰é’®
- ç‚¹å‡»åæ‰“å¼€å³ä¾§æ»‘å‡ºé¢æ¿ï¼ŒåŒ…å«ï¼š
  - **å…±äº« API é…ç½®**ï¼šAPI è¿æ¥è®¾ç½® + æ¨¡å—ç®¡ç†ï¼ˆå¯ç”¨/æ›´æ–°æ–¹å¼ï¼‰
  - **æ¨¡æ¿æç¤ºè¯**ï¼šå„æ¨¡å—æç¤ºè¯ç¼–è¾‘ï¼ŒåŒæ­¥åˆ°ä¸–ç•Œä¹¦ã€Œå·¥å…·ä¹¦ã€
  - **æ¨¡å—è¯¦ç»†è®¾ç½®**ï¼šå„æ¨¡å—ç‹¬ç«‹è®¾ç½®é¢æ¿ï¼Œå†…éƒ¨åŠŸèƒ½åˆ†ç±»æŠ˜å 

---

## UI ç»“æ„

```
é¡¶æ æŒ‰é’® (ğŸ”§)
  â””â”€â”€ å³ä¾§æ»‘å‡ºé¢æ¿
      â”œâ”€â”€ ğŸ”Œ å…±äº« API é…ç½®
      â”‚   â”œâ”€â”€ ğŸ“‹ æ¨¡å—ç®¡ç†ï¼ˆå¯ç”¨å¼€å…³ + æ›´æ–°æ–¹å¼ï¼‰
      â”‚   â””â”€â”€ ğŸ”— API è¿æ¥ï¼ˆé¢„è®¾/è‡ªå®šä¹‰URL/å¯†é’¥/æ¨¡å‹/å‚æ•°ï¼‰
      â”œâ”€â”€ ğŸ“ æ¨¡æ¿æç¤ºè¯ï¼ˆä¸–ç•Œä¹¦ï¼‰
      â”‚   â””â”€â”€ å„æ¨¡å—æç¤ºè¯ç¼–è¾‘ textarea + ä¿å­˜æŒ‰é’®
      â””â”€â”€ ğŸ“Š å„æ¨¡å—è®¾ç½®
          â””â”€â”€ åˆ†ç±»æŠ˜å çš„å­é¢æ¿ï¼ˆè¯·æ±‚è®¾ç½®/å†…å®¹å¤„ç†/æ“ä½œï¼‰
```

---

## ä¸–ç•Œä¹¦ã€Œå·¥å…·ä¹¦ã€

æ’ä»¶å¯ç”¨æ—¶è‡ªåŠ¨åˆ›å»º/æ£€æŸ¥ä¸–ç•Œä¹¦ï¼Œç”¨äºå­˜å‚¨å„æ¨¡å—çš„æ¨¡æ¿æç¤ºè¯ï¼š

| æ¡ç›® Key | æ¥æºæ¨¡å— | è¯´æ˜ |
|----------|----------|------|
| `statusbar_system_prompt` | StatusBar | çŠ¶æ€æ ç”Ÿæˆç³»ç»Ÿæç¤ºè¯ |

æ¨¡å—é€šè¿‡ `templatePrompts` å±æ€§å£°æ˜éœ€è¦çš„æç¤ºè¯æ¡ç›®ï¼Œæ’ä»¶åˆå§‹åŒ–æ—¶è‡ªåŠ¨åŒæ­¥åˆ°ä¸–ç•Œä¹¦ã€‚
è¿è¡Œæ—¶ä¼˜å…ˆä»ä¸–ç•Œä¹¦è¯»å–æç¤ºè¯ï¼Œç”¨æˆ·å¯é€šè¿‡ä¸–ç•Œä¹¦ UI æˆ–æ’ä»¶é¢æ¿ç¼–è¾‘ã€‚

---

## æ¨¡å—è§„èŒƒ

```js
export const MyModule = {
    id: 'my_module',
    name: 'ğŸ“¦ æ¨¡å—åç§°',
    defaultSettings: { enabled: true, update_mode: 'extra_model', ... },

    // æ¨¡æ¿æç¤ºè¯ï¼ˆå¯é€‰ï¼Œä¼šåŒæ­¥åˆ°ä¸–ç•Œä¹¦ï¼‰
    templatePrompts: { my_prompt_key: 'é»˜è®¤æç¤ºè¯å†…å®¹' },

    init() {},
    async onMessage(msgId) {},
    onChatReady(data) {},
    renderUI(settings) { return html; },  // è¿”å›æ¨¡å—è¯¦ç»†è®¾ç½® HTMLï¼ˆä½¿ç”¨ stk-sub-section åˆ†ç±»æŠ˜å ï¼‰
    bindUI(settings, save) {},
};
```

æ³¨æ„ï¼šæ¨¡å—çš„ `enabled` å’Œ `update_mode` å·²é›†æˆåˆ°å…±äº« API é…ç½®çš„ã€Œæ¨¡å—ç®¡ç†ã€ä¸­ï¼Œ
`renderUI` åªéœ€è¿”å›æ¨¡å—ç‰¹æœ‰çš„è¯¦ç»†è®¾ç½®ã€‚

---

## è®¾ç½®å­˜å‚¨ç»“æ„

```
extensionSettings['smart-toolkit'] = {
    _shared: { use_preset, api_url, api_key, model_name, max_tokens, temperature, stream },
    statusbar: { enabled, update_mode, auto_request, retry_count, request_mode, ... },
}
```

---

*æ–‡æ¡£æœ€åæ›´æ–°ï¼š2026-02-26*
